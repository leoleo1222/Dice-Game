<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="userinfo">
      <div id="username"></div>
      <div id="betting-chips">
        <div class="chip" id="chip1" onclick="bet(localStorage.getItem('username'), -1)">
          1
        </div>
        <div class="chip" id="chip5" onclick="bet(localStorage.getItem('username'), -5)">
          5
        </div>
        <div class="chip" id="chip10" onclick="bet(localStorage.getItem('username'), -10)">
          10
        </div>
      </div>
    </div>
    <div id="gameboy">
      <div id="sum"></div>
      <div id="screen">
        <div id="dice-container">
          <div class="dice" id="dice1"></div>
          <div class="dice" id="dice2"></div>
          <div class="dice" id="dice3"></div>
        </div>
        <button onclick="rollDice()">Roll Dice</button>
      </div>
      <div id="sums-container"></div>
    </div>
    <div id="record-board">
      <h2>Record Board</h2>
    </div>
  </div>
</body>
<script>
  function bet(username, amount) {
    const url = "/add_amount";
    const data = {
      username: username,
      amount: parseFloat(amount),
    };

    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.message) {
          alert(data.message);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }
  document.getElementById("username").textContent =
    localStorage.getItem("username");
</script>
<script>
  class DiceGame {
    constructor() {
      this.diceFaces = ["⚀", "⚁", "⚂", "⚃", "⚄", "⚅"];
    }

    rollDice() {
      var dice1 = Math.floor(Math.random() * 6);
      var dice2 = Math.floor(Math.random() * 6);
      var dice3 = Math.floor(Math.random() * 6);

      document.getElementById("dice1").textContent = this.diceFaces[dice1];
      document.getElementById("dice2").textContent = this.diceFaces[dice2];
      document.getElementById("dice3").textContent = this.diceFaces[dice3];

      var sum = dice1 + dice2 + dice3 + 3; // +3 because diceFaces is 0-indexed
      document.getElementById("sum").textContent = "Sum: " + sum;
      document.getElementById("sum").classList.add("sum-row"); // Add the sum-row class

      // Save the sum to the Flask API
      this.saveSum(sum);
    }

    saveSum(sum) {
      fetch("/save", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ sum: sum }),
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("HTTP error " + response.status);
          }
          return response.json();
        })
        .then((json) => console.log(json))
        .catch(function () {
          console.log("Error occurred while fetching /save");
        });
    }

    getSums() {
      fetch("/get")
        .then((response) => response.json())
        .then((data) => {
          var sumsContainer = document.getElementById("sums-container");
          sumsContainer.innerHTML = ""; // Clear the container
          data.forEach((record, index) => {
            var row = document.createElement("div");
            row.textContent = record.Sum;
            row.className = "sum-row"; // Add a CSS class to the row
            sumsContainer.appendChild(row);
          });
        });
    }

    getPercentages() {
      fetch("/percentage")
        .then((response) => response.json())
        .then((data) => {
          var recordBoard = document.getElementById("record-board");
          recordBoard.innerHTML = ""; // Clear the record board

          // Create and append the title
          var title = document.createElement("h2");
          title.textContent = "Record Board";
          recordBoard.appendChild(title);

          var proportions = data[0].proportions;
          for (var sum in proportions) {
            var row = document.createElement("div");
            var percentage = (proportions[sum] * 100).toFixed(2); // Convert to percentage
            row.textContent = "Sum " + sum + ": " + percentage + "%";
            recordBoard.appendChild(row);
          }

          // Fetch the data from the /bigsmall endpoint and append it to the record board
          this.getBigSmall();
        });
    }

    getBigSmall() {
      fetch("/bigsmall")
        .then((response) => response.json())
        .then((data) => {
          var recordBoard = document.getElementById("record-board");
          var proportions = data[0].proportions;
          for (var type in proportions) {
            var row = document.createElement("div");
            var percentage = (proportions[type] * 100).toFixed(2); // Convert to percentage
            row.textContent = type + ": " + percentage + "%";
            recordBoard.appendChild(row);
          }
        });
    }
  }

  // Create a new instance of the game
  var game = new DiceGame();

  // Call getPercentages every second to keep the record board up to date
  setInterval(() => game.getPercentages(), 1000);

  // Call getSums every second to keep the displayed sums up to date
  setInterval(() => game.getSums(), 1000);

  // Attach the rollDice method to the button
  document
    .querySelector("button")
    .addEventListener("click", () => game.rollDice());
</script>

</html>